# 네트워크(Network)

- Written in Nov. 12. 2021
- Authored by Jaycol Kim <jaycol@gmail.com>

## NAT (Network Address Translation)

대부분의 집에서 공유기를 가지고 있다. 공유기는 홈 라우터(Home Router)라고 불리곤 한다.`인터넷에서 쓰는 IP 주소`와 `공유기 내에서 쓰는 IP 주소`는 다른데 각각 `공인 IP 주소`, `사설 IP 주소`라고 불린다. 홈 라우터에는 이 공인 IP 주소와 사설 IP 주소 간 주소지를 변환해주는 기능이 포함되어 있는데, 이를 **NAT**라고 부른다.
192.168.10.1 과 같이 32비트 형태의 IPv4 주소는 최대 2^32 = 4,294,967,296 개 만큼의 컴퓨터에 주소를 할당해 줄 수 있는데 42억여개의 주소가 초기에는 충분해 보였지만 점차 인터넷에 연결된 컴퓨터/노드의 개수가 증가하면서 여유롭지 않은 실정이다. IP 주소의 절약을 위해 NAT 시스템이 적극적으로 사용되고 있으며, 다른 대안으로서 IPv6 주소를 할당해주는 방법도 있다.

### Basic NAT

사설 IP 주소와 공인 IP 주소의 범위는 겹쳐지지 않게 구성되어 있으며, 사설 IP 주소로 쓸 수 있는 범위는 다음과 같다:

- `10.*.*.*`
- `172.16.*.*` ~ `172.31.*.*`
- `192.168.*.*`

공유기 펌웨어를 조금이라도 뜯어봤던 사람이라면 `192.168.10.1`, `172.30.1.1` 과 같은 공유기 게이트웨이 주소에 익숙할 것인데, 이렇게 192.168 또는 172.30 으로 시작하는 IP 주소로 설정한 이유도 사설 IP 주소로 쓸 수 있는 범위가 위와 같아서다. 위와 같은 사설 IP 대역이 생겨난 이유는 Classful IP Address 시절에 대한 규칙성 때문인데, 추후에 관련 내용 또한 서술해보겠다.

기본적으로 NAT는 사설 IP 갯수만큼 공인 IP를 가지고 인터넷 연결을 한다. 1:1로 translation 하는 만큼 내부 네트워크의 IP 주소만큼 공인 IP를 할당해주어야 하므로 그만큼 많은 공인 IP를 소모하지만 주로 기업망에서 보안 목적으로 Basic NAT를 둠으로서 인터넷 통신 간 상태를 들여다본다.

### NAPT

복수 개의 사설 IP와 포트를 같이 묶어서 하나의 공인 IP 주소에 매핑한다. N:1 translation 으로서, 일반 가정에서 쓰는 공유기 역시 NAPT 방법으로서 하나의 공인 IP를 사용애 공인 IP주소를 절약하는 방식으로 이용한다.

Basic NAT, NAPT 모두 RFC 3022 표준으로서, Traditional NAT로 등록되어있다.

### NAT 변환 순서

1. 클라이언트가 웹서버로 요청을 전송한다. 이 때, 출발지의 IP는 사설 IP 주소다.
1. 인터넷으로 가기 위해 거쳐가는 공유기는 웹서버로 요청을 전송하기 전 출발지 IP 주소를 공인 IP 주소로 변환한다.
1. 공유기는 NAT 테이블에 변환한 주소 내용을 보존한다. (`Address Binding`)
1. 웹서버에서 공유기로 응답을 줄 때, 목적지 IP를 사설 IP 주소로 변환한다. (`Address Lookup and Translation`)
1. 일정시간동안 라우터 NAT 테이블에서 해당하는 주소의 패킷이 흐르지 않으면 세션 엔트리를 삭제한다. (`Address Unbinding`)

## NAT와 프록시의 차이?

NAT와 프록시 모두 IP 변환이 이루어지기에 목적지에서 실제 출발지 IP를 알 수 없어 보안성을 증가시키는 효과가 있다. 그러면 두 기능의 차이는 무엇일까?

- 프록시 서버는 L7 애플리케이션 계층에서 동작한다. HTTP, FTP 프로토콜 단에서 변환 작업이 이루어지며, 출발지와 목적시 사이에 중개자 역할을 한다는데 포커스되어있다.
- NAT는 L3 네트워크 계층에서 동작한다. IP 패킷을 수정하며, 사설 IP와 공인 IP를 Mapping 하는 역할을 한다.
- 때문에 특정 IP 주소만 접근가능하게 하거나 특정 User-Agent에 따라 다른 주소로 안내하게 하거나 인증 기능을 넣게 하는 작업 등은 프록시 서버에서만 작업할 수 있다. 또한 캐싱 기능 또한 프록시 서버에서만 적용할 수 있다.

프록시 서버는 대체적으로 회사 사내망이나 DMZ 존에 존재하며, NAT는 라우터나 방화벽에 위치하여 동작한다.
